// Generated by CoffeeScript 1.6.3
(function() {
  var module;

  module = angular.module('totem.Object', []);

  module.factory('AppObject', function($state, $firebase) {
    var AppObject;
    AppObject = (function() {
      function AppObject() {
        this.root = new Firebase("https://resplendent-fire-8698.firebaseio.com/");
        this.sync = $firebase(this.root);
        this.usersSync = $firebase(this.root.child("users"));
        this.users = this.usersSync.$asObject();
        this.postsSync = $firebase(this.root.child("posts"));
        this.posts = this.postsSync.$asObject();
        this.user = {};
        this.loggedIn = false;
        this.amount = '';
        this.text = '';
        this.imageFile = false;
      }

      AppObject.prototype.login = function(username) {
        var userRef, userSync;
        console.log("logging in with username: " + username);
        userRef = this.root.child("users/" + username);
        userSync = $firebase(userRef);
        this.user = userSync.$asObject();
        this.user.username = username;
        this.user.$save();
        this.loggedIn = true;
        return $state.go('home');
      };

      AppObject.prototype.logout = function() {
        this.user = {};
        this.loggedIn = false;
        return $state.go('');
      };

      AppObject.prototype.post = function() {
        var newPost;
        console.log(Parse);
        if (!this.user.username) {
          alert("please signin");
          $state.go('/');
        }
        newPost = {
          user: this.user.username,
          text: this.text,
          amount: this.amount
        };
        return this.posts.$push(newPost).then(function(result) {
          var PostObject, post;
          console.log("new post saved in firebase: " + result);
          console.log("image file: " + this.imageFile.name);
          PostObject = new Parse.Object.extend("Post");
          post = new PostObject();
          post.set("firebase_id", result.name());
          return post.save(null, function(post) {
            var file, name, parsefile;
            console.log("post saved in parse: " + post);
            file = this.imageFile;
            name = file.name;
            parsefile = new Parse.File(name, file);
            return parsefile.save().then(function(imageFile) {
              console.log("image successfully saved");
              post.set("image", imageFile);
              return post.save().then(function() {
                return $state.go('home');
              });
            });
          }, function(error) {
            console.log(error);
            return $state.go('home');
          });
        });
      };

      AppObject.prototype.getPostsForCause = function(id) {};

      AppObject.prototype.getCause = function(id) {};

      return AppObject;

    })();
    return window.app = new AppObject();
  });

}).call(this);
